<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Chatroom</title>
    <link rel="stylesheet" type="text/css" href="./index.css" />
    <script src="./chatroom.js"></script>
    <script>
        "use strict";
        const chat = new Chatroom();

        const btn1onclick = () => {
            const input1 = document.querySelector('#input1')

            chat.sendMsg(input1.value);
            input1.value = '';
            input1.focus();
        }

        const btn2onclick = () => {
            const name = document.querySelector('#input2').value;
            if (name === '') {
                alert('请输入一个昵称')
            } else {
                chat.setUsername(name)

                const msgdiv = document.querySelector("#msg");
                const userdiv = document.querySelector("#userlist");
                chat.init((data) => {
                    switch (data?.type) {
                        case "hello":
                            break;
                        case "msg":
                            msgdiv.innerHTML += getmsgDivNew(data?.data, data?.data?.name === chat.currentUsername);
                            break;
                        case "change":
                            msgdiv.innerHTML += getEnterLeaveDiv(data?.data);
                            break;
                        case "userlist":
                            userdiv.innerHTML = getuserlistItemDiv(data?.data?.users)
                            break;
                        default:
                            break;
                    }
                    msgdiv.scrollTop = msgdiv.scrollHeight;
                }, () => {
                    msgdiv.innerHTML += getserverstatusDiv();
                });
            }
        }

        const getuserlistItemDiv = (users) => {
            return users.map(user => {
                return `
                <li style=" display: flex; align-items: center;">
                            <div
                                style="border-radius: 10px; width: 10px; height: 10px; background-color:${user?.status === 'on' ? '#4fdd54' : 'rgb(138, 138, 138)'}; box-shadow: 0 0 3px 0 gray; margin-right: 5px;">
                            </div><span style="color: ${user?.status === 'on' ? 'black' : 'rgb(138, 138, 138)'} ;">${user?.name}</span>
                        </li>
                `;
            }).join('');
        }

        const getmsgDiv = (msg) => {
            return `
            <div style="margin-bottom: 10px;">
                <p><span style="margin-right: 10px;">${msg.name}</span><span style="color: gray;">${msg.date}</span></p>
                <p><b>${msg.text}</b></p>
            </div>
            `
        }

        const getserverstatusDiv = () => {
            return `
            <div style="margin-bottom: 10px; width: 100%; display: flex; justify-content: center;">
                        <span
                            style="width: fit-content; font-size: 0.8em; background-color: gray; color: white; border-radius: 10px; padding: 0 10px;">
                            ${'服务器已关闭'}
                            </span>
                    </div>
            `
        }

        const getEnterLeaveDiv = (data) => {
            let text = '';
            if (data?.name === chat.currentUsername) {
                switch (data.status) {
                    case 'enter':
                        text = `以 ${data?.name} 的身份加入聊天`
                        break;
                    case 'leave':
                        text = `你已离开聊天`
                        break;
                    default: break;
                }
            } else {
                switch (data.status) {
                    case 'enter':
                        text = `${data.name} 进来了`
                        break;
                    case 'leave':
                        text = `${data.name} 离开了`
                        break;
                    default: break;
                }
            }
            return `
            <div style="margin-bottom: 10px; width: 100%; display: flex; justify-content: center;">
                        <span
                            style="width: fit-content; font-size: 0.8em; background-color: gray; color: white; border-radius: 10px; padding: 0 10px;">
                            ${text}
                            </span>
                    </div>
            `
        }

        const getmsgDivNew = (msg, isSelf = false) => {
            return `
                    <div style="margin-bottom: 10px; width: 100%; display: flex; flex-direction: column;">
                        <div style="align-self: ${isSelf ? 'end' : 'start'}; width: fit-content; max-width: 60%; display: flex; flex-direction: column;">
                            <div style="margin-bottom: 3px; width: 100%; display: flex; gap: 10px; ">
                                ${isSelf ?
                    `<span style="color: gray; font-size: 0.5em;">${msg.date}</span>
                                    <span style="color: rgb(0, 0, 0); font-size: 0.8em;">${msg.name}</span>
                                `
                    : `<span style="color: rgb(0, 0, 0); font-size: 0.8em;">${msg.name}</span>
                                <span style="color: gray; font-size: 0.5em;">${msg.date}</span>`

                }
                                
    
                            </div>
                            <div
                                style="max-width: 100%; overflow-wrap: break-word; align-self: ${isSelf ? 'end' : 'start'};width: fit-content;  background-color: ${isSelf ? '#2196f3' : 'white'}; color: ${isSelf ? 'white' : 'black'}; border-radius: 10px; padding: 5px 10px; box-shadow: 0 0 3px 0 gray;">

                                <span style="font-size: 1.1em;">${msg.text}</span>
                            </div>
                        </div>
                    </div>
            `;
        }

    </script>
</head>

</html>

<body>
    <div id="container">
        <div id="panel">
            <div id="left">
                <div id="msg">
                    <!--div style="margin-bottom: 10px;">
                        <p><span style="margin-right: 10px;">az</span><span style="color: gray;">2022-02-22 22:22:22</span></p>
                        <p><b>rua</b></p>
                    </div-->
                    <!--div style="margin-bottom: 10px; width: 100%; display: flex; justify-content: center;">
                        <span
                            style="width: fit-content; font-size: 0.8em background-color: gray; color: white; border-radius: 10px; padding: 0 10px;">123123
                            进来了</span>
                    </div>
                    <div style="margin-bottom: 10px; width: 100%; display: flex; flex-direction: column;">
                        <div
                            style="align-self: start; width: fit-content; max-width: 60%; display: flex; flex-direction: column;">
                            <div style="margin-bottom: 3px; width: 100%; display: flex; gap: 10px; ">
                                <span style="color: rgb(0, 0, 0); font-size: 0.8em;">田所浩二</span><span
                                    style="color: gray; font-size: 0.5em;">2022-02-02 22:22:22</span>

                            </div>
                            <div
                                style="align-self: start;width: fit-content;  background-color: white; color: black; border-radius: 10px; padding: 5px 10px; box-shadow: 0 0 3px 0 gray;">

                                <span style="font-size: 1.1em;">message message message message message message message
                                    message </span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px; width: 100%; display: flex;  flex-direction: column;">
                        <div
                            style="align-self: end; width: fit-content; max-width: 60%; display: flex; flex-direction: column;">
                            <div style="margin-bottom: 3px; width: 100%; display: flex; gap: 10px; ">
                                <span style="color: gray; font-size: 0.5em;">2022-02-02 22:22:22</span>
                                <span style="color: rgb(0, 0, 0); font-size: 0.8em;">田所浩二</span>

                            </div>
                            <div
                                style="align-self: end; width: fit-content; background-color: #2196f3; color: rgb(255, 255, 255); border-radius: 10px; padding: 5px 10px; box-shadow: 0 0 3px 0 gray;">

                                <span style="font-size: 1.1em;">喵 </span>
                            </div>
                        </div>
                    </div-->

                </div>

                <div id="btncontainer">

                    <input id="input1" type="text" value="" />
                    <button id="sendbtn" onclick="btn1onclick()">发送</button>
                </div>
            </div>
            <div id="right">
                <div id="nameinputDiv">

                    <label style="display: flex; height: fit-content; gap: 5px;"><span
                            style="min-width: fit-content; font-size: 0.8em;"></span> <input id="input2" type="text"
                            value="" placeholder="昵称 (必需)" /></label>
                    <button id="namebtn" onclick="btn2onclick()">连接</button>
                </div>

                <div style="margin-top: 10px;">
                    <p style="font-size: 0.8em; color: gray;">在线用户</p>
                    <ul id="userlist" style="list-style-type: none; padding-left: 0; margin: 0; ">
                        <!--li style=" display: flex; align-items: center;">
                            <div
                                style="border-radius: 10px; width: 10px; height: 10px; background-color: rgb(6, 181, 6); box-shadow: 0 0 3px 0 gray; margin-right: 5px;">
                            </div><span>asdasdasd</span>
                        </li>
                        <li style=" display: flex; align-items: center;">
                            <div
                                style="border-radius: 10px; width: 10px; height: 10px; background-color: rgb(154, 154, 154); box-shadow: 0 0 3px 0 gray; margin-right: 5px;">
                            </div><span style="color: rgb(138, 138, 138);">asdasdasd</span>
                        </li-->
                    </ul>
                </div>

            </div>
        </div>

    </div>
</body>